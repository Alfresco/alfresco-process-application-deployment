image: alpine:latest

variables:
  KUBERNETES_VERSION: 1.8.6
  HELM_VERSION: 2.8.2

stages:
- deploy

deploy:
  stage: deploy
  script:
    - install_dependencies
    - setup_git
    - setup_build_helm_tools
    - export helm_chart_repo='http://kubernetes-charts.alfresco.com/incubator/'
    - export git_repo='git@github.com:Alfresco/charts.git'
    - export git_repo_subdir='incubator'
    - export chart_source_dirs='helm/alfresco-process-services-infrastructure'
    - ${HELM_TOOLS_HOME}/bin/helm-updater.sh
  when: manual
  allow_failure: true

.auto_devops: &auto_devops |

  function install_dependencies() {
    apk add -U openssl curl tar gzip bash ca-certificates git openssh
    wget -q -O /etc/apk/keys/sgerrand.rsa.pub https://alpine-pkgs.sgerrand.com/sgerrand.rsa.pub
    wget https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.23-r3/glibc-2.23-r3.apk
    apk add glibc-2.23-r3.apk
    rm glibc-2.23-r3.apk

    curl "https://kubernetes-helm.storage.googleapis.com/helm-v${HELM_VERSION}-linux-amd64.tar.gz" | tar zx
    mv linux-amd64/helm /usr/bin/
    helm version --client

    curl -L -o /usr/bin/kubectl "https://storage.googleapis.com/kubernetes-release/release/v${KUBERNETES_VERSION}/bin/linux/amd64/kubectl"
    chmod +x /usr/bin/kubectl
    kubectl version --client
  }

  function setup_git() {
    git clone --depth 1 https://$GITLAB_USER:$GITLAB_PASSWORD@git.alfresco.com/Build/bamboo-agent-config.git
    mkdir ~/.ssh
    cp ./bamboo-agent-config/keys/idgit_rsa ~/.ssh/id_rsa
    chmod 400 ~/.ssh/id_rsa
    git config --global user.name "alfresco-build"
    git config --global user.email "alfresco-build@alfresco.com"
    export GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa"
    ssh-keyscan github.com >> ~/.ssh/known_hosts
  }

  function setup_build_helm_tools() {
    git clone --depth 1 https://$GITLAB_USER:$GITLAB_PASSWORD@git.alfresco.com/platform-services/bamboo-build-helm-tools.git
    export HELM_TOOLS_HOME="./bamboo-build-helm-tools"
  }

before_script:
  - *auto_devops

